{{ if eq .chezmoi.os "linux" -}}
#!/bin/bash
set -e  # Exit on error

# Enable Multilib repository if not enabled
if ! grep -q '^\[multilib\]' /etc/pacman.conf; then
  echo "Enabling Multilib repository..."
  sudo sed -i '/#\[multilib\]/s/^#//' /etc/pacman.conf
  sudo sed -i '/#Include = \/etc\/pacman.d\/mirrorlist/s/^#//' /etc/pacman.conf
  sudo pacman -Sy  # Refresh package database
fi

# Ensure base-devel is installed for AUR support
if ! pacman -Qq base-devel &>/dev/null; then
  echo "Installing base-devel..."
  sudo pacman -Sy --needed --noconfirm base-devel
fi

# Ensure yay is installed
if ! command -v yay >/dev/null 2>&1; then
  echo "Installing yay..."
  sudo pacman -Sy --needed --noconfirm git go
  git clone https://aur.archlinux.org/yay.git /tmp/yay
  cd /tmp/yay
  makepkg -si --noconfirm
  cd - && rm -rf /tmp/yay
fi

# Install all necessary packages before applying configs
echo "Installing Pacman packages..."
sudo pacman -Sy --needed --noconfirm {{ range .packages.arch.pacman }}{{ . }} {{ end }}

echo "Installing AUR packages..."
yay -Sy --needed --noconfirm {{ range .packages.arch.aur }}{{ . }} {{ end }}
{{ end -}}
